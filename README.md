# DRC-BE

Back-end server for [Crypthub](https://crypthub-app.vercel.app). A crypto trading website which offers two main services which is a Peer-to-Peer (P2P) and a real-time trading market.

## Server built using:

- [Nodejs](https://nodejs.org/en):
- [PostgresDB](https://www.postgresql.org/):
- [Redis](https://redis.io/):
- [Nginx](https://www.nginx.com/):

## Scripts used:

<!-- - `sudo docker-compose up` : to run the containers (Node and Postgres).
- `sudo docker-compose down` : to stop and remove the containers (Node and Postgres).
- `sudo docker exec -it db-postgres-container psql -U [db username] -d [database name]` : to access the postgress container. -->

### Scripts:

- `clearUnusedImages.sh`:

  - The script is used to remove unused docker images.
  - run the script using `./clearUnusedImages.sh`.

- `initialSetup.sh`:

  - Run this script during the initial setup:
    - Add an ssh-agent.
    - Executes `git pull origin main` to get the latest version of the server.
    - Starts the docker containers.

- `update.sh`:
  - This script is executed using `crontab` to automatically pull the changes from the main branch for the purpose of getting changes.

### Ports:

If error appears such as this: `bind: address already in use.` <br>
Resolve the issue by using the follwoing commands:

- `sudo lsof -i:[PORT]`:
  - Run to see if there are anything running on the port.
- `sudo kill -9 [PID]`:
  - Run to kill anything with the given PID running on the port <br>

## APIs (Application Programming Interfaces)

---

Below is the list of APIs that the client website uses:

## User API Endpoints

#### Register new users

- **Endpoint:** `/registerUser`
- **Method:** POST
- **Description:** Registers new users
- **Request:** `{name, email, password}`
- **Response:**

```json
{
  "message": "USER_CREATED"
}
```

#### Login new users

- **Endpoint:** `/loginUser`
- **Method:** POST
- **Description:** Logs in verified users
- **Request:** `{email, password}`
- **Response:**

```json
{
  "message": "LOGIN_SUCCESSFUL",
  "details": {
    "token": "",
    "id": 2,
    "name": "deilan",
    "email": "deilanraj9799@gmail.com",
    "USD": 0,
    "BTC": 0,
    "ETH": 0
  }
}
```

#### Password Forgot (Forgot Password)

- **Endpoint:** `/forgotPassword`
- **Method:** POST
- **Description:** Resets user's password
- **Request:** `{email}`
- **Response:**

```json
{
  "message": "EMAIL_SENT"
}
```

**NOTE: ONCE THE EMAIL LINK HAS BEEN CLICK, ANOTHER RESPONSE WILL BE SENT**

```json
{
  "message": "SEND_NEW_PASSWORD_TO_USER"
}
```

#### Password Reset (Reset Password)

- **Endpoint:** `/resetPassword`
- **Method:** POST
- **Description:** Resets user's password
- **Request:** `{old_password, new_password}`
- **Response:**

```json
{
  "message": "RESET_PASSWORD_SUCCESS"
}
```

#### Logout users

- **Endpoint:** `/logoutUser`
- **Method:** POST
- **Description:** Logs out users
- **Response:**

```json
{
  "message": "LOGOUT_SUCCESS"
}
```

#### Checks blacklist for tokens

- **Endpoint:** `/checkBlacklist`
- **Method:** POST
- **Description:** Checks the cache for blacklisted authorization tokens
- **Response:**

```json
{
  "message": "TOKEN_IS_BLACKLISTED"
}
```

#### Verifies account

- **Endpoint:** `/verify/:token`
- **Method:** GET
- **Description:** Checks if the token in the URL is the same as the one generated by the server

## Trade API Endpoints

#### Buy crypto, ETH or BTC

- **Endpoint:** `/buy`
- **Method:** POST
- **Description:** Users buy either ETH or BTC coins using their virtual USD
- **Request:** `{coin_currency, current_price, coin_amount, request_header}`
- **Response:**

```json
{
  "message": "BUY_ORDER_SUCCESS",
  "details": {
    "coinCurrency": "BTC",
    "walletBalance": {
      "USD": 7254.49,
      "BTC": 1.4186936699999995,
      "ETH": 0
    }
  }
}
```

#### Sell crypto, ETH or BTC

- **Endpoint:** `/sell`
- **Method:** POST
- **Description:** Users sell their own ETH or BTC and earn virtual USD
- **Request:** `{coin_currency, current_selling_price, coin_amount, request_header}`
- **Response:**

```json
{
  "message": "SELL_ORDER_SUCCESS",
  "details": {
    "coinCurrency": "ETH",
    "walletBalance": {
      "BTC": 0.9751948447414551,
      "ETH": 13.559141073176196,
      "USD": 1824.38
    }
  }
}
```

## Wallet API Endpoints

#### Deposit money into USD wallet

- **Endpoint:** `/walletDeposit`
- **Method:** POST
- **Description:** Users can deposit any amount into the wallet
- **Request:** `{request_header, amount}`
- **Response:**

```json
{
  "message": "DEPOSIT_SUCCESS",
  "details": {
    "balance": 60000
  }
}
```

#### Withdraw money from USD wallet

- **Endpoint:** `/walletWithdraw`
- **Method:** POST
- **Description:** Users can withdraw any amount from the wallet
- **Request:** `{request_header, amount}`
- **Response:** Similar to [deposit](#deposit-money-into-usd-wallet)

#### Get wallet transaction history

- **Endpoint:** `/walletTransaction`
- **Method:** GET
- **Description:** Retrieves all of user's deposit and withdrawal history
- **Request:** Req.headers

#### Get wallet balance

- **Endpoint:** `/currentWalletBalance`
- **Method:** GET
- **Description:** Returns the current wallet balance
- **Request:** Req.headers

## Transaction API Endpoints

#### Get all buy and sell transactions

- **Endpoint:** `/getAllTransactions`
- **Method:** GET
- **Description:** Retrieve all the buy and sell orders
- **Request:** Request.headers

## P2P API Endpoints

#### Create a new P2P contract

- **Endpoint:** `/addP2PContract`
- **Method:** POST
- **Description:** Creates a new P2P contract and adds it in the database
- **Request:** `{currency, coin_amount, selling_price}`, Req.headers
- **Response:**

```json
{
  "message": "CONTRACT_ADDED",
  "details": {
    "wallet_balance": {
      "USD": 52586.13,
      "BTC": 0.07570000000000002,
      "ETH": 0
    }
  }
}
```

#### Buy P2P contract

- **Endpoint:** `/buyContract`
- **Method:** POST
- **Description:** Buy a P2P contract
- **Request:** `{contract_id}`, Req.headers
- **Response:**

```json
{
  "message": "CONTRACT_PURCHASE_SUCCESFUL",
  "details": {
    "USD": 38586.13,
    "BTC": 0.08020000000000002,
    "ETH": 0
  }
}
```

#### Delete P2P contract

- **Endpoint:** `/deleteContract`
- **Method:** POST
- **Description:** Delete a P2P contract
- **Request:** `{contract_id}`, Req.headers
- **Response:**

```json
{
  "message": "CONTRACT_DELETED",
  "details": {
    "USD": 51586.13,
    "BTC": 0.08230000000000001,
    "ETH": 0
  }
}
```

#### Get all P2P contracts for marketplace

- **Endpoint:** `/getOpenContracts`
- **Method:** GET
- **Description:** Retrieves all the open P2P contracts
- **Response:**

```json
{
  "message": "SUCCESS",
  "details": [
    {
      "contract_id": "b1b28720-3983-4501-a2cc-42f8ca08b5cd",
      "seller_id": 1,
      "currency": "BTC",
      "coin_amount": 0.0045,
      "selling_price": 14000,
      "created_at": "2023-07-14T03:36:02.011Z"
    },
    {
      "contract_id": "14799ba3-1bfc-479b-b938-b59e6e0feb08",
      "seller_id": 2,
      "currency": "BTC",
      "coin_amount": 0.0066,
      "selling_price": 1000,
      "created_at": "2023-07-14T03:36:09.598Z"
    }
  ]
}
```

#### Get ongoing P2P contracts of the user

- **Endpoint:** `/getOngoingContracts`
- **Method:** GET
- **Description:** Retrieves the open P2P contracts for a specific user
- **Request:** Req.headers
- **Response:**

```json
{
  "message": "SUCCESS",
  "details": [
    {
      "contract_id": "99c20d0b-5882-4d4c-b43d-3addcfed0d1e",
      "seller_id": 2,
      "currency": "BTC",
      "coin_amount": 0.0066,
      "selling_price": 1000,
      "created_at": "2023-07-14T03:29:58.403Z"
    }
  ]
}
```

#### Get all completed contracts based on the userID

- **Endpoint:** `/getCompletedContracts`
- **Method:** GET
- **Description:** Retrieves all the bought, sold, and deleted contracts for a specific user
- **Request:** Req.headers
- **Response:**

```json
{
  "message": "SUCCESS",
  "details": [
    {
      "contract_id": "b1b28720-3983-4501-a2cc-42f8ca08b5cd",
      "seller_id": 1,
      "currency": "BTC",
      "coin_amount": 0.0045,
      "selling_price": 14000,
      "created_at": "2023-07-14T03:36:02.011Z",
      "completed_at": "2023-07-14T03:37:38.670Z",
      "transaction_type": "bought"
    },
    {
      "contract_id": "3d81d8af-0e2c-49e8-9960-05bd115a1e1b",
      "seller_id": 2,
      "currency": "BTC",
      "coin_amount": 0.0066,
      "selling_price": 1000,
      "created_at": "2023-07-14T03:33:38.953Z",
      "completed_at": "2023-07-14T03:34:25.099Z",
      "transaction_type": "delete"
    },
    {
      "contract_id": "99c20d0b-5882-4d4c-b43d-3addcfed0d1e",
      "seller_id": 2,
      "currency": "BTC",
      "coin_amount": 0.0066,
      "selling_price": 1000,
      "created_at": "2023-07-14T03:29:58.403Z",
      "completed_at": "2023-07-14T03:32:10.718Z",
      "transaction_type": "sold"
    }
  ]
}
```

Please refer to the documentation for detailed information on each API endpoint and their usage.
